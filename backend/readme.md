### Kokline backend

## Api ##

### OpenApi

После любых изменений в api необходимо сгенерировать новую документацию.
Как это сделать
описано [тут](https://www.jetbrains.com/help/idea/ktor.html?_gl=1*gcbjc2*_ga*MTc0OTM3OTczNi4xNjk1MDI4OTE0*_ga_9J976DJZ68*MTY5NTg0Mzc0OC4xNS4xLjE2OTU4NDM4MTkuNTAuMC4w&_ga=2.8532853.1135182488.1695843749-1749379736.1695028914#openapi).
UI доступен по адресу http://localhost:8080/openapi

### Api

1. /chat/joinChat

Так как idea не может сгенерировать нормальное openApi для этой ручки придется его описать.
При подключении к websocket'у находящемуся по этой ручке, необходимо передать в качестве query параметра id - id
чата, к которому подключается пользователь.
Также в хэдерах передается x-user-id - id подключающегося пользователя. В дальнейшем будет спрятано в jwt токене при
авторизации.
Бэк постоянно стримит новые сообщения от других пользователей в чат, контракт такой же как и в api сообщений.
Со стороны фронта можно создавать сообщения. Контракт на создание сообщения это класс WebSocketMessageRequest.
После создания сообщения, оно отправиться всем пользователям подключенным к чату, в том числе к отправителю.

## Запуск приложения ##

### Preconditions

На машине должен быть установлен docker, либо установлены редис и постгрес.

### Config

По дефолту приложение подключается по следующим адресам:

- Postgres: localhost:5433/kokline
- Redis: localhost:6479

Эти параметры могу быть переопределены с помощью env переменнных.

- POSTGRES_URL - jdbc url postgres
- TODO добавить env var для редиса

Либо же из самого [конфига](/src/main/resources/application.conf)

### Запуск инфры

Перед запуском приложения необходимо запустить postgres и redis. Для этого можно использовать идею
и [docker-compose.yaml](../docker-compose.yaml).
Тыкаете на стрелки запуска нужных контейнеров и все. Idea сама запустит контейнеры и подключит к единой сети. Либо через
консоль с использованием

      docker run -d -p 5433:5432 -e "POSTGRES_USER=postgres" -e "POSTGRES_DB=kokline" -e "POSTGRES_PASSWORD=123" postgis/postgis:15-3.3-alpine
      docker run -d -p 6379:6379 redis/redis-stack:7.2.0-v3

После этого можно запустить приложение из ide с использование
файла [ApplicationMainKt](/src/main/kotlin/kek/team/kokline/ApplicationMain.kt)

### Запуск приложения через docker

Запускаете [docker-compose.yaml](../docker-compose.yaml) из идее, либо командой

      docker-compose run -d

После этого приложение запуститься на порту 8080. Порт можно переопределить
в [docker-compose.yaml](../docker-compose.yaml)

        services:
            backend:
                ports:
                    - 8080:8080

## Internal info ##

### Каналы сообщений в redis

Все каналы используемые при распространении ивентов имеют следующий формат:

      events:{сущность с которой связан ивент}:{подсущность}: ... :{event_type}

Само сообщение имеет формат, при котором каждая сущность определяется своим id. Что позволяет уникально идентифицировать
сущность из ивента.

      {id  сущность}:{id подсущности}: ...

Внутри ChannelConsumer'а к сообщению в начале будет добавлен канал в который он был отправлен.

      {Название канала}|{Сообщение из канала}
